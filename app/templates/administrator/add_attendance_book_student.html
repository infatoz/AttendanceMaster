{% extends "administrator/base.html" %}
{% block title %} Add Students to Attendance Book {% endblock title %}
{% block content %}

<div class="pagetitle">
  <h1>Add Students to Attendance Book</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'view_attendance_books' %}">Attendance Books</a></li>
      <li class="breadcrumb-item">Add Students to Attendance Book</li>
    </ol>
  </nav>
</div>

<div
class="alert alert-danger alert-dismissible fade show"
role="alert"
>
<i class="bi bi-exclamation-octagon me-1"></i>
<b>Important Note: </b><br>
Please don't click on back button & do not refresh the page. Select the Students (Select atleast 1 Student to Attendance Book, Don't leave empty) and Confirm, then click on <b>Add Students & Finish</b> button to create Attendance Book
<button
  type="button"
  class="btn-close"
  data-bs-dismiss="alert"
  aria-label="Close"
></button>
</div>


<section class="section">
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Select Students to Attendance Book</h5>
          <form method="post" id="attendanceForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary mb-3">
              Add Students & Finish<i class="bi bi-check-circle ms-2"></i>
            </button>
            <button type="button" class="btn btn-sm btn-secondary mb-3" id="selectAllBtn">
              Select All Filtered Students
            </button>
            <div class="row">
              <div class="col-md-6">
                <input type="text" id="studentSearch" class="form-control mb-2" placeholder="Search Students">
                <input type="text" id="courseSearch" class="form-control mb-2" placeholder="Search by Course">
                <input type="text" id="yearSearch" class="form-control mb-2" placeholder="Search by Year">
                <input type="text" id="sectionSearch" class="form-control mb-2" placeholder="Search by Section">
                <ul class="list-group" id="studentList">
                  {% for student in students %}
                  <li class="list-group-item">
                    <input type="checkbox" name="students" value="{{ student.user.userid }}" class="studentCheckbox">
                    <img src="{{ student.photo_url }}" alt="{{ student.user.fullname }}" style="height: 50px; margin-right: 10px;">
                    {{ student.user.userid }} - {{ student.user.fullname }} - {{ student.course.name }}  - {{ student.section }}
                  </li>
                  {% endfor %}
                </ul>
                <button type="button" id="loadMore" class="btn btn-link">Load more</button>
              </div>
              <div class="col-md-6">
                <h6>Selected Students: <span id="selectedCount">0</span></h6>
                <ul class="list-group" id="selectedStudentsList">
                  <!-- Selected students will appear here -->
                </ul>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  $(document).ready(function () {
    var page = 1;

    function fetchStudents(query, queryCourse, queryYear, querySection, page) {
      $.ajax({
        url: "{% url 'filter_students' %}",
        data: { query: query, queryCourse: queryCourse, queryYear: queryYear, querySection: querySection, page: page },
        success: function (data) {
          var studentList = $("#studentList");
          if (page === 1) {
            studentList.empty();
          }
          data.students.forEach(function (student) {
            studentList.append(
              `<li class="list-group-item">
                <input type="checkbox" class="studentCheckbox" value="${student.userid}">
                <img src="${student.photo_url}" alt="${student.fullname}" style="height: 50px; margin-right: 10px;">
                ${student.userid} - ${student.fullname} - ${student.course} - ${student.year} - ${student.section}
              </li>`
            );
          });
          if (!data.has_next) {
            $("#loadMore").hide();
          } else {
            $("#loadMore").show();
          }
        }
      });
    }

    // Initial load
    fetchStudents('', '', '', '', page);

    // Search functionality
    function handleSearchInputs() {
      var query = $("#studentSearch").val();
      var queryCourse = $("#courseSearch").val();
      var queryYear = $("#yearSearch").val();
      var querySection = $("#sectionSearch").val();
      page = 1;
      fetchStudents(query, queryCourse, queryYear, querySection, page);
    }

    $("#studentSearch, #courseSearch, #yearSearch, #sectionSearch").on('input', handleSearchInputs);

    // Load more functionality
    $("#loadMore").click(function () {
      page++;
      handleSearchInputs();
    });

    // Handle student selection
    function updateSelectedCount() {
      $("#selectedCount").text($("#selectedStudentsList li").length);
    }

    $(document).on('change', '.studentCheckbox', function () {
      var selectedList = $("#selectedStudentsList");
      if (this.checked) {
        selectedList.append(
          `<li class="list-group-item" data-userid="${this.value}">
            ${$(this).next('img').prop('outerHTML')}
            ${$(this).closest('li').text()}
          </li>`
        );
      } else {
        selectedList.find(`li[data-userid="${this.value}"]`).remove();
      }
      updateSelectedCount();
    });

    // Select All functionality
    $("#selectAllBtn").click(function () {
      $(".studentCheckbox").each(function () {
        if (!this.checked) {
          this.checked = true;
          $(this).trigger('change');
        }
      });
    });

    // Handle form submission
    $("#attendanceForm").submit(function (event) {
      event.preventDefault();
      var selectedStudents = $("#selectedStudentsList li").map(function () {
        return $(this).data('userid');
      }).get();

      // Append a hidden input with the list of selected students as a comma-separated string
      $('<input>').attr({
        type: 'hidden',
        name: 'students',
        value: selectedStudents.join(',')  // Join array to a comma-separated string
      }).appendTo(this);

      // Submit the form
      this.submit();
    });

  });
</script>

{% endblock content %}
