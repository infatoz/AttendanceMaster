{% extends "administrator/base.html" %}
{% block title %} View Attendance Report {% endblock title %}
{% block content %}

<div class="pagetitle">
  <h1>View Attendance Report</h1>
  <nav>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'view_attendnace_report' %}">View Attendance Report</a></li>
      <li class="breadcrumb-item">View Attendance Report</li>
    </ol>
  </nav>
</div>

<section class="section">
  <div class="row">
    <div class="col-lg-12">

      {% if messages %}
      <ul class="messages">
        {% for message in messages %} {% if message.tags == 'success' %}
        <div
          class="alert alert-success alert-dismissible fade show"
          role="alert"
        >
          <i class="bi bi-check-circle me-1"></i>
          {{message}}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endif %} {% if message.tags == 'error' %}
        <div
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          <i class="bi bi-exclamation-octagon me-1"></i>
          {{message}}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endif %} {% endfor %}
      </ul>
      {% endif %}

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Choose Date</h5>
          <form method="POST">
            {% csrf_token %}
            <div class="form-group mb-3">
              <label for="selected_date">Select Date</label>
              <input name="selected_date" type="date" class="form-control" id="selected_date" placeholder="Please select date" required>
            </div>
            <button type="submit" name="view_report" class="btn btn-sm btn-primary">View Report</button>
          </form>
        </div>

      {% if absentee_details %}
      <div class="card mt-3">
        <div class="card-header">
          <button id="sendSmsBtn" class="btn btn-sm btn-success mt-3">Send SMS to All Absentees</button>
          <!-- SMS Sending Button -->
          <!-- <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="selected_date" value="{{ selected_date }}">
            <button type="submit" name="send_sms" class="btn btn-sm btn-success mt-3">Send SMS to Absentees</button>
          </form> -->
        </div>
      </div>
        <div class="card-body">
          <h5 class="card-title">Absentees on {{ selected_date }}</h5>
          <table class="table table-bordered display nowrap" id="studentsTable" style="width: 100%">
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Full Name</th>
                <th>Parent Phone No</th>
                <th>Absent Sessions</th>
              </tr>
            </thead>
            <tbody>
              {% for student_id, student_data in absentee_details.items %}
              <tr>
                <td>{{ student_id }}</td>
                <td>{{ student_data.full_name }}</td>
                <td>{{ student_data.parent_phoneno }}</td>
                <td>
                  {% for session in student_data.absent_sessions %}
                  <p>{{ session.subject_name }} (Code: {{ session.subject_code }}) Session: {{ session.session }}</p>
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
  $(document).ready(function () {
    $("#studentsTable").DataTable({
      order: [[1, "asc"]],
      scrollX: true,
      paging: true,
      pageLength: 50,
      lengthMenu: [50, 100, 150, 200, 250, 500],
      dom: "Bfrtip",
      buttons: [
        // Data export options
        // omitted for brevity
      ],
    });

    // Handle SMS button click
    $('#sendSmsBtn').on('click', function() {
      if (confirm('Are you sure you want to send SMS to all absentees?')) {
        $.ajax({
          url: "{% url 'send_absentee_sms' %}",  // Ensure you have the correct URL mapped
          method: "POST",
          data: {
            'selected_date': "{{ selected_date }}", // Pass the selected date
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            if (response.success) {
              alert('SMS sent successfully to ' + response.sent_count + ' parents.');
            } else {
              alert('Failed to send SMS. Error: ' + response.error);
            }
          },
          error: function(xhr, status, error) {
            alert('An error occurred: ' + error);
          }
        });
      }
    });

  });
</script>

{% endblock content %}
